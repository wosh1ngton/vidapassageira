<div class="planejar-viagem-container">
    <!-- Header da Viagem -->
    <div class="viagem-header">
        <div class="header-content">
            <button pButton icon="pi pi-arrow-left"
                    class="p-button-rounded p-button-text back-button"
                    (click)="voltar()"
                    pTooltip="Voltar para viagens">
            </button>
            <div class="viagem-info">
                <h1 class="viagem-titulo">
                    <i class="pi pi-map-marker"></i>
                    {{viagem?.destino?.nome}}
                </h1>
                <p class="viagem-periodo">
                    <i class="pi pi-calendar"></i>
                    {{viagem?.dataIda | date:'dd/MM/yyyy'}} até {{viagem?.dataVolta | date:'dd/MM/yyyy'}}
                </p>
            </div>
        </div>
    </div>

    <!-- Menu de Navegação -->
    <div class="menu-navegacao">
        <div class="menu-tabs">
            <button *ngFor="let item of items"
                    class="menu-tab"
                    [class.active]="isMenuActive(item.label)"
                    (click)="item.command && item.command()"
                    pRipple>
                <i [class]="item.icon"></i>
                <span>{{ item.label }}</span>
            </button>
        </div>
    </div>
    <!-- Conteúdo Principal -->
    <div class="content-area">
        <!-- Loading Indicator -->
        <div *ngIf="loadingIA" class="loading-container">
            <div class="loading-content">
                <div class="loading-spinner">
                    <i class="pi pi-spin pi-spinner"></i>
                </div>
                <h3 class="loading-title">{{ loadingMessage }}</h3>
                <p class="loading-subtitle">Isso pode levar alguns segundos...</p>
                <div class="loading-progress"></div>
            </div>
        </div>

        <!-- Conteúdo quando não está loading -->
        <div *ngIf="!loadingIA" class="content-wrapper">
            <!-- Onde Ir (Itinerário) -->
            <ng-container *ngIf="selectedSubMenu === tipoSugestaoEnum.ONDE_IR">
                <div class="section-header">
                    <div class="section-title">
                        <i class="pi pi-search"></i>
                        <h2>Seu Itinerário</h2>
                    </div>
                    <button pButton
                            icon="pi pi-plus"
                            label="Adicionar Atividade"
                            class="p-button-rounded"
                            (click)="adicionarItemItinerario()">
                    </button>
                </div>

                <app-itinerario-viagem
                    *ngIf="itinerarioDaViagem.length > 0"
                    (updatePagina)="getOndeIr()"
                    [atividades]="itinerarioDaViagem">
                </app-itinerario-viagem>

                <div class="empty-itinerario" *ngIf="itinerarioDaViagem.length === 0">
                    <i class="pi pi-map"></i>
                    <h3>Nenhuma atividade no itinerário</h3>
                    <p>Adicione atividades manualmente ou peça sugestões à IA</p>
                </div>

                <button pButton *ngIf="!hasItinerario"
                        label="Gerar Itinerário com IA"
                        icon="pi pi-sparkles"
                        class="p-button-lg ia-button"
                        (click)="gerarOpiniaoOndeIr(selectedSubMenu)">
                </button>
                <button pButton *ngIf="hasItinerario"
                        label="Regenerar Itinerário com IA"
                        icon="pi pi-refresh"
                        class="p-button-lg regenerar-button"
                        (click)="abrirDialogRegenerar(selectedSubMenu)">
                </button>
            </ng-container>

            <!-- Outras Sugestões (Onde Ficar, Como Chegar, Onde Comer) -->
            <ng-container *ngIf="selectedSubMenu !== tipoSugestaoEnum.ONDE_IR">
                <div class="suggestion-card" *ngIf="sugestoes.has(selectedSubMenu!)">
                    <div class="card-header">
                        <h2>
                            <i [class]="getSugestaoIcon()"></i>
                            {{ getSugestaoTitulo() }}
                        </h2>
                        <button pButton
                                icon="pi pi-pencil"
                                class="p-button-rounded p-button-text"
                                *ngIf="sugestoesIds.get(selectedSubMenu!)"
                                pTooltip="Editar sugestão">
                        </button>
                    </div>
                    <div class="card-content">
                        <app-sugestao-ia
                            *ngIf="selectedSubMenu"
                            (sugestaoChange)="getSugestaoByViagemId()"
                            [tipoSugestao]="selectedSubMenu"
                            [sugestao]="sugestoes.get(selectedSubMenu)"
                            [id]="sugestoesIds.get(selectedSubMenu)">
                        </app-sugestao-ia>
                    </div>
                    <div class="card-footer">
                        <button pButton *ngIf="exibirBtnSalvarOpiniaoIA"
                                label="Salvar Sugestão"
                                icon="pi pi-check"
                                class="p-button-success"
                                (click)="salvarOpiniaoIA(sugestoes.get(selectedSubMenu))">
                        </button>
                        <button pButton *ngIf="sugestoesIds.get(selectedSubMenu!)"
                                label="Regenerar com IA"
                                icon="pi pi-refresh"
                                class="regenerar-button"
                                (click)="abrirDialogRegenerar(selectedSubMenu)">
                        </button>
                    </div>
                </div>

                <div class="empty-suggestion" *ngIf="!sugestoes.has(selectedSubMenu!)">
                    <i [class]="getSugestaoIcon()"></i>
                    <h3>{{ getSugestaoEmptyTitulo() }}</h3>
                    <p>{{ getSugestaoEmptyDescricao() }}</p>
                    <button pButton
                            label="Pedir Sugestão à IA"
                            icon="pi pi-sparkles"
                            class="p-button-lg ia-button"
                            (click)="gerarOpiniao(selectedSubMenu)">
                    </button>
                </div>
            </ng-container>
        </div>
    </div>

    <!-- Dialog de Regeneração -->
    <p-dialog header="Regenerar Sugestão" [(visible)]="mostrarDialogRegenerar"
              [modal]="true" [style]="{width: '500px'}" [closable]="true"
              [breakpoints]="{'640px': '90vw'}">
        <div class="regenerar-dialog-content">
            <p class="regenerar-dialog-info">
                <i class="pi pi-info-circle"></i>
                O conteúdo atual será substituído por uma nova sugestão da IA.
            </p>
            <div class="regenerar-field">
                <label class="regenerar-label">Instrução personalizada (opcional)</label>
                <textarea pInputTextarea [(ngModel)]="instrucaoUsuario"
                          placeholder="Ex: Gostaria de opções mais econômicas, priorizando a natureza..."
                          rows="3" [style]="{width: '100%'}" [autoResize]="true">
                </textarea>
            </div>
        </div>
        <ng-template pTemplate="footer">
            <div class="regenerar-dialog-footer">
                <p-button label="Cancelar" icon="pi pi-times" severity="secondary"
                          [outlined]="true" (onClick)="cancelarRegenerar()"></p-button>
                <p-button label="Regenerar" icon="pi pi-sparkles"
                          styleClass="regenerar-confirm-button"
                          (onClick)="confirmarRegenerar()"></p-button>
            </div>
        </ng-template>
    </p-dialog>
</div>